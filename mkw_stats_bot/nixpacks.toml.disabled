[build]
providers = ["python"]

[build.env]
PYTHONUNBUFFERED = "1"
PYTHONDONTWRITEBYTECODE = "1"
# Force headless mode for graphics libraries  
DISPLAY = ""
QT_QPA_PLATFORM = "offscreen"
MPLBACKEND = "Agg"
# OpenCV headless configuration
OPENCV_IO_ENABLE_OPENEXR = "false"
OPENCV_IO_ENABLE_JASPER = "false"
# PaddleX configuration for production deployment
PADDLE_PDX_MODEL_SOURCE = "BOS"

[phases.setup]
# Install system packages needed for headless OpenCV and PaddleX
aptPkgs = [
    "libglib2.0-0",
    "libsm6",
    "libxext6", 
    "libxrender1",
    "libgomp1"
]

# CACHE BUSTER: Updated 2025-01-08 - Force Railway rebuild with explicit paddlex[ocr] install
[phases.postInstall]
dependsOn = ["install"]  
cmds = [
    "echo 'ğŸ”§ NIXPACKS: Post-install fixes for PaddleX OCR deployment (v2025-01-08)...'",
    # EXPLICIT: Ensure paddlex[ocr] is installed (force reinstall to be sure)
    ". /opt/venv/bin/activate && pip install 'paddlex[ocr]>=3.0.0' --force-reinstall --no-cache-dir",
    # Remove any GUI OpenCV that might have been installed as dependencies
    ". /opt/venv/bin/activate && pip uninstall -y opencv-python opencv-contrib-python || echo 'No GUI OpenCV found'",
    # Ensure headless OpenCV is installed
    ". /opt/venv/bin/activate && pip install opencv-contrib-python-headless>=4.5.0 --force-reinstall",
    # Verify installation with detailed output
    "echo 'ğŸ” Checking installed packages...'",
    ". /opt/venv/bin/activate && pip list | grep -E '(paddlex|paddle|opencv)'",
    # Verify functionality
    ". /opt/venv/bin/activate && python -c 'import cv2; print(f\"âœ… OpenCV {cv2.__version__} verified\")' || echo 'âŒ OpenCV verification failed'",
    ". /opt/venv/bin/activate && python -c 'from paddlex import create_pipeline; print(\"âœ… PaddleX OCR ready\")' || echo 'âŒ PaddleX verification failed'",
    "echo 'âœ… NIXPACKS: Installation verification completed (v2025-01-08)'"
]

[start]
cmd = "python main.py"